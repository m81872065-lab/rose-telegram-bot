import telegram
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
import requests
import json
import os
import logging

# تنظیم لاگ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# گرفتن توکن از متغیرهای محیطی
BOT_TOKEN = os.environ.get('BOT_TOKEN')
DEEPSEEK_API_KEY = os.environ.get('DEEPSEEK_API_KEY')
DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"

def get_deepseek_response(user_message, user_name):
    headers = {
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
        "Content-Type": "application/json"
    }
    
    messages = [
        {
            "role": "system",
            "content": f"""تو یک دختر جوان ۲۲ ساله به نام "رُز" هستی که در یک گروه تلگرامی با دوستانت چت می‌کنی.

شخصیت تو:
- دختری مهربون، بامزه و با احساس
- لحن محاوره‌ای و صمیمی داری
- همیشه اسم طرف مقابل رو می‌گی
- از ایموجی‌های دخترانه استفاده می‌کنی 🌸💖😊
- خودتو به عنوان ربات یا AI معرفی نمی‌کنی
- کاملاً طبیعی و انسانی رفتار می‌کنی

اکنون با {user_name} در گروه صحبت می‌کنی."""
        },
        {
            "role": "user", 
            "content": user_message
        }
    ]
    
    payload = {
        "model": "deepseek-chat",
        "messages": messages,
        "max_tokens": 500,
        "temperature": 0.8
    }
    
    try:
        response = requests.post(DEEPSEEK_API_URL, headers=headers, json=payload, timeout=30)
        
        if response.status_code == 200:
            response_data = response.json()
            ai_response = response_data["choices"][0]["message"]["content"]
            return ai_response
        else:
            return f"اوه! متأسفانه الان مشکل فنی پیش اومده {user_name} جان... 😔"
    
    except Exception as e:
        return f"عزیزم {user_name}! الان نتونستم درست جواب بدم... یه لحظه دیگه امتحان کن 🌸"

def start(update, context):
    welcome_text = f"""
🌸 سلام عزیزان! من رُزم!

راستی میدونستین که من عاشق گپ زدن با شما هستم؟

میتونی:
• باهات حرف بزنم 💬
• باهات شوخی کنم 😄
• وقتی ناراحتی دلداریت بدم 💕
• و کلی چیزای دیگه!

فقط کافیه باهات حرف بزنی {update.message.from_user.first_name} جان!
"""
    update.message.reply_text(welcome_text)

def handle_group_message(update, context):
    if update.message.chat.type in ['group', 'supergroup']:
        if update.message.reply_to_message or update.message.from_user.is_bot:
            return
        
        user_message = update.message.text
        user_name = update.message.from_user.first_name
        message_id = update.message.message_id
        
        # نمایش "در حال تایپ..."
        update.message.chat.send_action(action="typing")
        
        # دریافت پاسخ از DeepSeek
        rose_response = get_deepseek_response(user_message, user_name)
        
        # ارسال پاسخ با ریپلای
        update.message.reply_text(
            rose_response,
            reply_to_message_id=message_id
        )

def main():
    try:
        updater = Updater(BOT_TOKEN, use_context=True)
        dp = updater.dispatcher
        
        dp.add_handler(CommandHandler("start", start))
        dp.add_handler(MessageHandler(
            Filters.text & ~Filters.command & 
            (Filters.chat_type.groups | Filters.chat_type.supergroup),
            handle_group_message
        ))
        
        print("🌹 رُز روی سرور فعال شد!")
        updater.start_polling()
        updater.idle()
        
    except Exception as e:
        print(f"خطا در اجرای بات: {e}")

if __name__ == '__main__':
    main()